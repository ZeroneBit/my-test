{"version":3,"sources":["services/MyFile.js","services/MyPeer.js","../node_modules/peerjs/dist sync","components/MyFileReceiver.js","services/MyEnums.js"],"names":["MyFile","options","Object","classCallCheck","this","size","name","create","fileStream","streamSaver","createWriteStream","writer","getWriter","defineProperty","Blob","prototype","configurable","enumerable","writable","value","Response","body","data","done","_this","console","log","byteLength","reader","stream","getReader","pump","read","then","res","write","close","MyPeer","possibleConstructorReturn","getPrototypeOf","call","CHUNK_SIZE","peer","pairs","outgoing","_initializePeer","remoteId","_ensureConnection","conn","open","message","type","EventTypes","Request_File_Infos","send","PeerEvents","Info_Got","fileInfo","inc","incoming","find","f","assign","file","_requestFileChunk","files","_this2","_loop","i","item","findIndex","o","push","length","Peer","debug","confi","iceServers","url","credential","username","on","_peerOpen","bind","_peerConnection","_peerDisconnected","_peerClose","_peerError","id","emit","Peer_Opened","pair","_initializeConnection","err","error","callback","connect","openCallback","_this3","undefined","_onJSONData","_connError","_connClose","Response_File_INfos","payload","Array","from","Request_File_Chunk","_sendFileChunk","Response_File_Chunk","_receiveFileChunk","chunkIndex","index","_this4","last","append","File_Got","File_Progress","FileReader","blob","isLastChunk","start","end","slicedBlob","slice","mozSlice","webkitSlice","onload","event","readyState","DONE","blockBuffer","target","result","readAsArrayBuffer","EventEmitter","webpackEmptyContext","req","e","Error","code","keys","resolve","module","exports","MyFileReceiver","props","D_Test_my_test_node_modules_babel_runtime_helpers_esm_classCallCheck__WEBPACK_IMPORTED_MODULE_0__","D_Test_my_test_node_modules_babel_runtime_helpers_esm_possibleConstructorReturn__WEBPACK_IMPORTED_MODULE_2__","D_Test_my_test_node_modules_babel_runtime_helpers_esm_getPrototypeOf__WEBPACK_IMPORTED_MODULE_3__","match","params","myPeer","state","peerFiles","initializeMyPeer","selfId","peerId","setState","downloading","requestFileInfos","downloadFile","classes","react__WEBPACK_IMPORTED_MODULE_5___default","a","createElement","_material_ui_core__WEBPACK_IMPORTED_MODULE_6__","variant","component","className","button","color","onClick","retriveFileInfos","renderFileInfos","_material_ui_core__WEBPACK_IMPORTED_MODULE_7__","title","paperBackground","_material_ui_core__WEBPACK_IMPORTED_MODULE_8__","dense","map","_material_ui_core__WEBPACK_IMPORTED_MODULE_9__","key","_material_ui_core__WEBPACK_IMPORTED_MODULE_10__","_material_ui_core__WEBPACK_IMPORTED_MODULE_11__","_material_ui_icons_Folder__WEBPACK_IMPORTED_MODULE_16___default","_material_ui_core__WEBPACK_IMPORTED_MODULE_12__","primary","secondary","_material_ui_core__WEBPACK_IMPORTED_MODULE_13__","_material_ui_core__WEBPACK_IMPORTED_MODULE_14__","edge","aria-label","disabled","_material_ui_icons_CloudDownload__WEBPACK_IMPORTED_MODULE_17___default","React","Component","withStyles","theme","margin","spacing","buttonInput","display","backgroundColor","palette","background","paper","withTheme"],"mappings":"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","file":"static/js/8.97dd175a.chunk.js","sourcesContent":["import streamSaver from 'streamsaver';\r\n\r\nexport default class MyFile {\r\n    constructor(options) {\r\n\r\n        this.size = options.size;\r\n        this.name = options.name;\r\n\r\n        this.create = true;\r\n        this.fileStream = streamSaver.createWriteStream(\r\n            this.name,\r\n            { size: this.size, }\r\n        );\r\n        this.writer = this.fileStream.getWriter();\r\n\r\n        Object.defineProperty(Blob.prototype, 'stream', {\r\n            configurable: true,\r\n            enumerable: true,\r\n            writable: true,\r\n            value: function stream() {\r\n              return new Response(this).body;\r\n            }\r\n          });\r\n    }\r\n\r\n    append(data, done) {\r\n        console.log(data.byteLength);\r\n        const blob = new Blob([data]);\r\n        const readableStream = blob.stream();\r\n        // if(this.fileStream && readableStream.pipeTo){\r\n        //     readableStream.pipeTo(this.fileStream);\r\n        // }\r\n        const reader = readableStream.getReader();\r\n        const pump = () => reader.read()\r\n            .then(res => {\r\n                if (res.done) {\r\n                    done();\r\n                } else {\r\n                    this.writer.write(res.value).then(pump);\r\n                }\r\n            });\r\n\r\n        pump();\r\n    }\r\n\r\n    close() {\r\n        this.writer.close();\r\n    }\r\n\r\n\r\n\r\n    _reset() {\r\n\r\n    }\r\n}","import { EventEmitter } from 'eventemitter3';\r\nimport Peer from 'peerjs';\r\n\r\nimport { EventTypes, PeerEvents } from './MyEnums';\r\nimport MyFile from './MyFile';\r\n\r\nexport default class MyPeer extends EventEmitter {\r\n\r\n    constructor() {\r\n        super();\r\n\r\n        this.CHUNK_SIZE = 16 * 1024 * 1024;\r\n\r\n        this.peer = null;\r\n        this.pairs = {};\r\n        this.outgoing = [];\r\n\r\n        this._initializePeer();\r\n    }\r\n\r\n    //publics\r\n\r\n    requestFileInfos(remoteId) {\r\n        this._ensureConnection(remoteId, (conn) => {\r\n            console.log(\"sending request \" + conn.open);\r\n            const message = {\r\n                type: EventTypes.Request_File_Infos,\r\n            };\r\n            conn.send(message);\r\n        });\r\n\r\n        return PeerEvents.Info_Got;\r\n    }\r\n\r\n    downloadFile(remoteId, fileInfo) {\r\n        let inc = this.pairs[remoteId].incoming.find(f => f.name === fileInfo.name);\r\n        Object.assign(inc, {\r\n            file: new MyFile({ name: inc.name, size: inc.size }),\r\n        });\r\n\r\n        this._requestFileChunk(remoteId, fileInfo, 0);\r\n    }\r\n\r\n    setOutgingFiles(files) {\r\n        if (files) {\r\n            for (let i = 0; i < files.length; i++) {\r\n                let f = files.item(i);\r\n                if (this.outgoing.findIndex(o => o.name == f.name) < 0) {\r\n                    this.outgoing.push(f);\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n\r\n    //privates\r\n    _initializePeer() {\r\n        this.peer = new Peer(null, {\r\n            debug: 3,\r\n            confi: {\r\n                'iceServers': [\r\n                    { url: 'stun:stun.services.mozilla.com' },\r\n                    { url: 'turn:numb.viagenie.ca', credential: 'muazkh', username: 'webrtc@live.com' }\r\n                ],\r\n            },\r\n        });\r\n\r\n        this.peer.on('open', this._peerOpen.bind(this));\r\n        this.peer.on('connection', this._peerConnection.bind(this));\r\n        this.peer.on('disconnected', this._peerDisconnected.bind(this));\r\n        this.peer.on('close', this._peerClose.bind(this));\r\n        this.peer.on('error', this._peerError.bind(this));\r\n    }\r\n    _peerOpen(id) {\r\n        this.emit(PeerEvents.Peer_Opened, id);\r\n    }\r\n    _peerConnection(conn) {\r\n        let pair = this.pairs[conn.peer];\r\n        if (!pair || !pair.conn || !pair.conn.open) {\r\n            this.pairs[conn.peer] = { conn };\r\n            console.log(\"_peerConnection \" + conn.open);\r\n            this._initializeConnection(conn);\r\n        }\r\n    }\r\n    _peerDisconnected() { }\r\n    _peerClose() { }\r\n    _peerError(err) {\r\n        console.error(\"Peer error \" + err.type);\r\n        console.error(err);\r\n    }\r\n\r\n    _ensureConnection(remoteId, callback) {\r\n        let pair = this.pairs[remoteId];\r\n        if (!pair) {\r\n            this.pairs[remoteId] = {};\r\n            pair = this.pairs[remoteId];\r\n        }\r\n        if (!pair.conn || !pair.conn.open) {\r\n            pair.conn = this.peer.connect(remoteId)\r\n            console.log(\"this.peer.connect\" + pair.conn.open);\r\n            this._initializeConnection(pair.conn, callback);\r\n            return;\r\n        }\r\n\r\n        callback && callback(pair.conn);\r\n    }\r\n    _initializeConnection(conn, openCallback) {\r\n        conn.on('open', () => {\r\n            console.log(\"conn opened\");\r\n            openCallback && openCallback(conn);\r\n        });\r\n        conn.on('data', (data) => {\r\n            if (data.byteLength !== undefined) {\r\n\r\n            } else {\r\n                this._onJSONData(data, conn);\r\n            }\r\n        });\r\n        conn.on('error', (err) => { this._connError(err, conn); });\r\n        conn.on('close', () => { this._connClose(conn); });\r\n    }\r\n\r\n    _connError(err, conn) {\r\n        console.error(err);\r\n    }\r\n    _connClose(conn) {\r\n        console.error(\"conn closed\");\r\n    }\r\n\r\n    _onJSONData(data, conn) {\r\n        switch (data.type) {\r\n            case EventTypes.Request_File_Infos: {\r\n                const message = {\r\n                    type: EventTypes.Response_File_INfos,\r\n                    payload: Array.from(this.outgoing, function (f) { return { name: f.name, size: f.size, type: f.type, peer: this.id }; }, this.peer),\r\n                };\r\n                conn.send(message);\r\n            } break;\r\n            case EventTypes.Response_File_INfos: {\r\n                let pair = this.pairs[conn.peer];\r\n                pair.incoming = data.payload;\r\n\r\n                this.emit(PeerEvents.Info_Got, conn.peer, data.payload);\r\n            } break;\r\n\r\n            case EventTypes.Request_File_Chunk: {\r\n                this._sendFileChunk(data.payload, conn);\r\n            } break;\r\n            case EventTypes.Response_File_Chunk: {\r\n                this._receiveFileChunk(data.payload, conn);\r\n            } break;\r\n            default: console.error('Unknown message: ' + data);\r\n        }\r\n    }\r\n\r\n    _requestFileChunk(remoteId, fileInfo, chunkIndex) {\r\n        this._ensureConnection(remoteId, (conn) => {\r\n            console.log(\"download file \" + conn.open);\r\n            const message = {\r\n                type: EventTypes.Request_File_Chunk,\r\n                payload: { \r\n                    fileInfo: {\r\n                        name: fileInfo.name,\r\n                    }, \r\n                    index: chunkIndex },\r\n            };\r\n            conn.send(message);\r\n        });\r\n    }\r\n\r\n    _receiveFileChunk(payload, conn) {\r\n        let { index, fileInfo, data, last } = payload;\r\n        let inc = this.pairs[conn.peer].incoming.find(f => f.name === fileInfo.name);\r\n        inc.file.append(data, () => {\r\n            if (last) {\r\n                inc.file.close();\r\n                this.emit(PeerEvents.File_Got, fileInfo);\r\n            }\r\n            else {\r\n                this.emit(PeerEvents.File_Progress, fileInfo, index * this.CHUNK_SIZE);\r\n    \r\n                this._requestFileChunk(conn.peer, fileInfo, index + 1);\r\n            }\r\n        });\r\n    }\r\n\r\n    _sendFileChunk(payload, conn) {\r\n        const reader = new FileReader();\r\n\r\n        let fileInfo = payload.fileInfo;\r\n        let index = payload.index;\r\n        let blob = this.outgoing.find(f => f.name === fileInfo.name);\r\n        let isLastChunk = false;\r\n        let start = index * this.CHUNK_SIZE;\r\n        let end = start + this.CHUNK_SIZE;\r\n        if (end >= blob.size) {\r\n            end = blob.size;\r\n            isLastChunk = true;\r\n        }\r\n        let slice = blob.slice || blob.mozSlice || blob.webkitSlice;\r\n        let slicedBlob = slice.call(blob, start, end);\r\n\r\n        reader.onload = function (event) {\r\n            if(reader.readyState !== FileReader.DONE){\r\n                return;\r\n            }\r\n            const blockBuffer = event.target.result;\r\n            const message = {\r\n                type: EventTypes.Response_File_Chunk,\r\n                payload: {\r\n                    index: index,\r\n                    fileInfo: fileInfo,\r\n                    data: blockBuffer,\r\n                    last: isLastChunk,\r\n                },\r\n            };\r\n            conn.send(message);\r\n        }\r\n        reader.readAsArrayBuffer(slicedBlob);\r\n    }\r\n\r\n}","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 117;","import React from 'react';\r\nimport { Button, LinearProgress, TextField, Typography, List, ListItem, ListItemAvatar, Avatar, ListItemText, ListItemSecondaryAction, IconButton } from '@material-ui/core';\r\nimport { withStyles } from '@material-ui/core/styles';\r\nimport SvgIcon from '@material-ui/core/SvgIcon';\r\nimport Folder from '@material-ui/icons/Folder';\r\nimport Download from '@material-ui/icons/CloudDownload';\r\nimport MyPeer from '../services/MyPeer';\r\nimport { PeerEvents } from '../services/MyEnums';\r\n\r\nclass MyFileReceiver extends React.Component {\r\n    constructor(props) {\r\n        super(props);\r\n\r\n        this.remoteId = props.match.params.id;\r\n\r\n        this.myPeer = null;\r\n        this.state = {\r\n            peerFiles: []\r\n        };\r\n    }\r\n\r\n    componentWillMount() {\r\n        this.myPeer = new MyPeer();\r\n        this.initializeMyPeer();\r\n    }\r\n\r\n    initializeMyPeer() {\r\n        this.myPeer.on(PeerEvents.Peer_Opened, (selfId) => {\r\n            console.log(selfId);\r\n        });\r\n        this.myPeer.on(PeerEvents.Info_Got, (peerId, files) => {\r\n            console.log(files);\r\n            this.setState({ peerFiles: files });\r\n        });\r\n        this.myPeer.on(PeerEvents.File_Progress, (fileInfo, length) => {\r\n            console.log(\"got \" + length);\r\n        });\r\n        this.myPeer.on(PeerEvents.File_Got, (fileInfo) => {\r\n            let f = this.state.peerFiles.find(f => f.name === fileInfo.name);\r\n            f.downloading = false;\r\n            this.setState({});\r\n            console.log(\"finished\");\r\n        });\r\n    }\r\n\r\n    retriveFileInfos(event) {\r\n        this.myPeer.requestFileInfos(this.remoteId);\r\n    }\r\n\r\n    downloadFile(event, fileInfo) {\r\n        console.log(fileInfo);\r\n        fileInfo.downloading = true;\r\n        this.setState({});\r\n        this.myPeer.downloadFile(this.remoteId, fileInfo);\r\n    }\r\n\r\n    render() {\r\n\r\n        const { classes } = this.props;\r\n\r\n        return (\r\n            <div>\r\n                <Button variant=\"contained\" component=\"span\" className={classes.button}\r\n                    color=\"primary\" onClick={this.retriveFileInfos.bind(this)}>\r\n                    Retrive Files\r\n                </Button>\r\n                {\r\n                    this.state.peerFiles && this.state.peerFiles.length &&\r\n                    this.renderFileInfos()\r\n                }\r\n\r\n            </div>\r\n        );\r\n    }\r\n\r\n    renderFileInfos() {\r\n        const { classes } = this.props;\r\n\r\n        return (\r\n            <div>\r\n                <Typography variant=\"h6\" className={classes.title}>\r\n                    {this.remoteId}\r\n                </Typography>\r\n                <div className={classes.paperBackground}>\r\n                    <List dense={true} >\r\n                        {\r\n                            this.state.peerFiles.map((f) => {\r\n                                return (\r\n                                    <ListItem key={f.name}>\r\n                                        <ListItemAvatar>\r\n                                            <Avatar>\r\n                                                <Folder></Folder>\r\n                                            </Avatar>\r\n                                        </ListItemAvatar>\r\n                                        <ListItemText primary={f.name} secondary={f.size}>\r\n                                        </ListItemText>\r\n                                        <ListItemSecondaryAction>\r\n                                            <IconButton edge=\"end\" aria-label=\"Download\"\r\n                                                disabled={!!f.downloading}\r\n                                                onClick={(event) => { this.downloadFile(event, f) }}>\r\n                                                <Download></Download>\r\n                                            </IconButton>\r\n                                        </ListItemSecondaryAction>\r\n                                    </ListItem>)\r\n                            })\r\n                        }\r\n                    </List>\r\n                </div>\r\n            </div>);\r\n    }\r\n}\r\n\r\nconst styles = theme => ({\r\n    button: {\r\n        margin: theme.spacing(1),\r\n    },\r\n\r\n    buttonInput: {\r\n        display: 'none',\r\n    },\r\n\r\n    title: {\r\n        margin: theme.spacing(4, 0, 2),\r\n    },\r\n\r\n    paperBackground: {\r\n        backgroundColor: theme.palette.background.paper,\r\n    },\r\n});\r\n\r\nexport default withStyles(styles, { withTheme: true })(MyFileReceiver);","export class EventTypes {\r\n    static Request_File_Infos = 'request_file_infos';\r\n    static Response_File_INfos = 'response_file_infos';\r\n    static Request_File_Chunk = 'request_download_file_chunk';\r\n    static Response_File_Chunk = 'response_download_file_chunk';\r\n};\r\n\r\nexport class PeerEvents {\r\n    static Peer_Opened = 'peer_opened';\r\n    static Info_Got = 'info_got';\r\n    static File_Got = 'file_got';\r\n    static File_Progress = 'file_progress';\r\n}\r\n"],"sourceRoot":""}